# Flarum Deployment Test Plan

## ‚úÖ Objectives

This test plan validates the following core tenets of your deployment:

1. **Zero-touch** provisioning
2. **Idempotent** boot scripts
3. **Resilient** infrastructure (survives VM restarts and boot disk replacement)
4. **Automated and trusted SSL** provisioning and renewal
5. **Separation of concerns** (ephemeral boot disk vs persistent data disk)

---

## üî∞ Preconditions

* [x] Forum DNS (`forum-hub.team-apps.net`) points to correct IP
* [x] GCP Secrets Manager contains all required secrets
* [x] Data disk snapshot or tarball is available
* [x] Latest deployment scripts/configs pushed to repo

---

## ‚úÖ Phase 1: Fresh Boot / First-Time Deploy

* [x] Deploy with `LETSENCRYPT_ENV_STAGING=true`
* [x] Manually install production cert
* [x] Confirm staging cert is used initially and replaced cleanly
* [x] Git repo clones and `.flarum.env` is templated with secrets
* [x] `docker-compose up -d` runs without error
* [x] Forum UI loads at `forum-hub.team-apps.net`
* [x] Admin login works
* [x] Reboot VM and validate forum state is retained (users/posts)
  - ‚ùå **FAIL** - data disk does not mount correctly
  - ‚úÖ **PASS** - fix applied, retested [[bug] Data disk does not mount properly on reboot](https://github.com/ggrierson/comm-hub-flarum/issues/1)
* [x] Confirm secrets are pulled again cleanly

---

## ‚úÖ Phase 2: Critical Recovery Tests

* [ ] Delete and re-create boot disk, reuse data disk
* [ ] Validate automated recovery of forum
* [ ] Manually install prod cert and reboot
* [ ] Cert is preserved post-reboot
* [ ] Run `docker kill flarum`, recover with `docker-compose up -d`
* [ ] DNS update propagates correctly if temporarily changed

---

## ‚úÖ Phase 3: Idempotency / Re-runs

* [ ] `postboot.sh` exits early on reboot (marker file present)
* [ ] `.flarum.env` is consistently templated on repeat boots
* [ ] Real certs are retained, staging/bootstrap certs replaced
* [ ] Repo is not re-cloned if `.git` exists

---

## ‚úÖ Bonus: Observability Checks

* [ ] Cert is present in NGINX container (`docker exec flarum_nginx ls ...`)
* [ ] Verify cert issuer via `openssl x509` output
* [ ] `curl` a healthcheck file from ACME challenge dir externally
* [ ] Check logs with `journalctl` or serial console viewer

---

## üß™ Execution Tips

* Prioritize Phase 2 failures after validating Phase 1
* Run multiple tests before rebooting to maximize coverage (acceptable risk in this context)
* Use `DEBUG=true` temporarily for deeper inspection

---

## üìù Future Enhancements

* [ ] Automate post-deploy data disk snapshot
* [ ] Script full ACME HTTP-01 validation check
* [ ] Integrate this checklist into CI/pre-deploy workflow
